name: Sync Profile README Transmissions

on:
  workflow_dispatch:
  schedule:
    - cron: "17 */6 * * *"  # every 6 hours at minute 17

permissions:
  contents: write

concurrency:
  group: sync-profile-readme
  cancel-in-progress: true

jobs:
  sync:
    name: Update kronosguy profile README with latest transmissions
    runs-on: ubuntu-latest

    steps:
      - name: Require cross-repo PAT
        shell: bash
        run: |
          if [ -z "${{ secrets.README_SYNC_TOKEN }}" ]; then
            echo "Missing required secret README_SYNC_TOKEN."
            echo "Create a PAT with Contents: Read and write for kronosguy/kronosguy and store it as README_SYNC_TOKEN."
            exit 1
          fi

      - name: Checkout profile repo
        uses: actions/checkout@v4
        with:
          repository: kronosguy/kronosguy
          ref: main
          token: ${{ secrets.README_SYNC_TOKEN }}
          fetch-depth: 0

      - name: Ensure README blog markers exist
        shell: bash
        run: |
          if ! grep -q "<!-- BLOG-POST-LIST:START -->" README.md; then
            {
              echo ""
              echo "## Latest UKG Pro WFM Transmissions"
              echo "<!-- BLOG-POST-LIST:START -->"
              echo "- Awaiting first synchronized transmission."
              echo "<!-- BLOG-POST-LIST:END -->"
            } >> README.md
          fi

      - name: Render RSS into README (no commit/push)
        uses: gautamkrishnar/blog-post-workflow@v1
        with:
          comment_tag_name: BLOG-POST-LIST
          feed_list: https://kronosguy.com/rss.xml
          max_post_count: 3
          readme_path: README.md
          gh_token: ${{ secrets.README_SYNC_TOKEN }}
          skip_commit: true

      - name: Commit + push (rebase-safe)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "blog-post-bot"
          git config user.email "blog-post-bot@example.com"

          # Safety: ensure we push to the profile repo even if another step rewrites remotes
          git remote set-url origin "https://github.com/kronosguy/kronosguy.git"

          # Bring branch up to date without losing README edits
          git pull --rebase --autostash origin main

          # Nothing changed? bail.
          if git diff --quiet; then
            echo "No changes detected."
            exit 0
          fi

          git add README.md
          git commit -m "chore(profile): sync latest UKG Pro WFM transmissions"

          # Retry push to handle rare race conditions
          for attempt in 1 2 3; do
            if git push origin HEAD:main; then
              exit 0
            fi
            echo "Push rejected (attempt ${attempt}). Rebasing and retrying..."
            git pull --rebase --autostash origin main
          done

          echo "Push failed after 3 attempts."
          exit 1
